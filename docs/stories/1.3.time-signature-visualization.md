# Story 1.3: time-signature-visualization

## Status
Approved

## Story
**As a** composer and musician,
**I want** to set and visualize different time signatures (3/4, 5/4, 7/8, etc.) with appropriate beat groupings and visual subdivisions,
**so that** I can compose naturally in various musical time signatures rather than thinking only in 16th-note steps

## Acceptance Criteria
1. Users can select common time signatures: 4/4, 3/4, 5/4, 6/8, 7/8, 9/8, 12/8
2. Custom time signature input supports any numerator (beats) and denominator (note value)
3. Pattern grid visually groups steps according to the selected time signature (e.g., 3 groups of 4 for 3/4)
4. Beat emphasis and strong/weak beat indicators adapt to the time signature
5. Step numbering and visual separators reflect musical beats rather than raw step counts
6. Metronome and timing calculations align with musical beat structure
7. Time signature changes automatically adjust pattern length and visual layout
8. Multiple tracks can have different time signatures simultaneously (advanced feature)

## Business Value
- **Musician Appeal**: Makes Beatr accessible to traditionally-trained musicians
- **Workflow Enhancement**: Natural composition in familiar time signatures
- **Creative Expansion**: Enables complex polyrhythmic compositions
- **Professional Use**: Supports real-world musical production needs

## User Stories & Use Cases

### Primary Use Cases
1. **Classical Composer**: Wants to create a waltz in 3/4 time with clear downbeat emphasis
2. **Progressive Musician**: Needs 7/8 time signature for an odd-meter composition
3. **Electronic Producer**: Wants to experiment with 5/4 patterns for unique grooves
4. **Jazz Musician**: Requires 6/8 swing feel with triplet subdivisions

### Secondary Use Cases
1. **Polyrhythm Creator**: Different drum voices in different time signatures simultaneously
2. **World Music Producer**: Non-Western time signatures like 11/8 or 13/16
3. **Film Composer**: Changing time signatures within a single composition

## Technical Requirements

### Time Signature Data Structure
```rust
pub struct TimeSignature {
    numerator: u8,      // Number of beats (1-32)
    denominator: u8,    // Note value (1, 2, 4, 8, 16, 32)
    beats_per_measure: u8,
    subdivisions_per_beat: u8,
}
```

### Visual Grouping Logic
- **Beat Groups**: Major visual separators between beats
- **Subdivision Groups**: Minor separators within beats  
- **Emphasis Indicators**: Strong beats (downbeat) vs weak beats
- **Measure Boundaries**: Clear measure start/end markers

### Calculation Requirements
- **Steps per Beat**: `(loop_length * denominator) / (numerator * 4)`
- **Visual Groups**: Group steps by calculated beats
- **Metronome Sync**: Align audio timing with musical beats

## Tasks / Subtasks
- [ ] Design time signature data structure and validation (AC: 2)
  - [ ] Create TimeSignature struct with numerator/denominator
  - [ ] Implement common time signature presets (4/4, 3/4, 5/4, 6/8, 7/8, 9/8, 12/8)
  - [ ] Add custom time signature input with validation
  - [ ] Calculate steps-per-beat and visual grouping logic
- [ ] Create TimeSignatureControl UI component (AC: 1, 7)
  - [ ] Preset buttons for common time signatures
  - [ ] Custom numerator/denominator input fields
  - [ ] Real-time preview of resulting pattern layout
  - [ ] Integration with existing transport panel
- [ ] Update PatternGrid visual grouping (AC: 3, 4, 5)
  - [ ] Replace hardcoded 4-step grouping with time-signature-aware grouping
  - [ ] Implement beat-based visual separators (thick lines between beats)
  - [ ] Add subdivision separators within beats (thin lines)
  - [ ] Strong/weak beat emphasis (downbeat highlighting)
  - [ ] Musical step numbering (beat.subdivision format)
- [ ] Integrate with existing loop length system (AC: 7)
  - [ ] Sync time signature changes with pattern length adjustments
  - [ ] Ensure compatibility with custom loop lengths from Story 1.2
  - [ ] Handle edge cases where loop length doesn't align with time signature
- [ ] Audio timing and metronome alignment (AC: 6)
  - [ ] Update BPM calculations to reflect musical beats
  - [ ] Ensure audio playback aligns with visual beat emphasis
  - [ ] Add metronome click option with time signature awareness
- [ ] Advanced multi-track time signatures (AC: 8)
  - [ ] Per-track time signature configuration
  - [ ] Visual indication of different time signatures per track
  - [ ] Polyrhythmic playback coordination

## Dev Notes

### Relevant Source Tree Info
- `src/ui/components/pattern_grid.rs`: Current 4-step visual grouping logic needs time-signature awareness
- `src/ui/components/loop_length_control.rs`: Integration point for time signature controls
- `src/audio/sequencer.rs`: BPM and timing calculations may need musical beat alignment
- `src/ui/app.rs`: Transport panel integration for time signature controls

### Current Visual Grouping (4-step bars)
```rust
let is_bar_start = step % 4 == 0;
if is_bar_start && step > 0 {
    ui.separator();
}
```

### Proposed Visual Grouping (time-signature aware)
```rust
let beats_per_measure = time_signature.numerator;
let steps_per_beat = calculate_steps_per_beat(&time_signature, loop_length);
let is_beat_start = step % steps_per_beat == 0;
let is_downbeat = (step / steps_per_beat) % beats_per_measure == 0;
```

### Integration with Story 1.2
- **Compatibility**: Time signatures must work with any custom loop length
- **Priority**: If loop length conflicts with time signature, provide user choice
- **Fallback**: Default to step-based view when time signature doesn't align

### Visual Design Considerations
- **Beat Separators**: Thick vertical lines between beats
- **Subdivision Separators**: Thin vertical lines within beats  
- **Downbeat Emphasis**: Different color/style for beat 1
- **Step Labels**: "1.1, 1.2, 1.3, 1.4, 2.1, 2.2..." instead of "1, 2, 3, 4, 5, 6..."
- **Measure Numbers**: Optional measure numbering for longer patterns

### User Experience Flow
1. **Select Time Signature**: Choose from presets or enter custom
2. **Visual Update**: Pattern grid immediately shows new grouping
3. **Length Adjustment**: System calculates optimal loop length or user adjusts
4. **Compose**: Create patterns with natural musical emphasis
5. **Playback**: Audio timing aligns with visual beat structure

## Dependencies
- **Story 1.2**: Variable loop lengths (completed) - provides foundation for dynamic pattern sizing
- **Pattern Grid**: Current visual system needs enhancement for beat grouping
- **Transport Panel**: Space allocation for time signature controls

## Definition of Done
- [ ] All acceptance criteria met and tested
- [ ] Visual grouping works for all common time signatures
- [ ] Custom time signatures validate and display correctly
- [ ] Integration with existing loop length system seamless
- [ ] No regression in current functionality
- [ ] Comprehensive test coverage for time signature calculations
- [ ] User documentation updated with time signature workflow

## Testing Strategy

### Unit Tests
- TimeSignature struct validation (valid/invalid combinations)
- Steps-per-beat calculation accuracy
- Visual grouping logic for various time signatures
- Integration with different loop lengths

### Integration Tests  
- Time signature changes update pattern grid correctly
- Audio timing aligns with visual beat emphasis
- Preset buttons and custom input work seamlessly
- Compatibility with all existing Story 1.1 and 1.2 features

### User Experience Tests
- Musician workflow: compose in 3/4, verify natural feel
- Edge cases: very short/long time signatures (1/4, 15/8)
- Performance: complex time signatures don't slow UI
- Visual clarity: beat groupings clearly visible at all loop lengths

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-03 | 1.0 | Initial story creation based on user request | Claude Code (pm-agent) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev-agent during implementation_

### Debug Log References
_To be populated by dev-agent during implementation_

### Completion Notes List
_To be populated by dev-agent during implementation_

### File List
_To be populated by dev-agent during implementation_

## QA Results
_To be populated by qa-agent during QA review_